{% extends "base.html" %}

{% block title %}Email Forensics & Threat Analysis Pipeline | Architecture Explorer{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Extend tailwind config for this page
    tailwind.config.theme.extend.colors = {
        ...tailwind.config.theme.extend.colors,
        background: '#fafaf9', // stone-50
        surface: '#ffffff',
        primary: '#4f46e5', // indigo-600
        secondary: '#0d9488', // teal-600
        textMain: '#1e293b', // slate-800
        textMuted: '#64748b', // slate-500
    };
    tailwind.config.theme.extend.fontFamily = {
        sans: ['Inter', 'sans-serif'],
    };
</script>
{% endblock %}

{% block extra_css %}
/* FIXED: 'body' selector (was 'ody') */
body {
background-color: #fafaf9;
color: #1e293b;
}

/* Chart Container Styling - MANDATORY */
.chart-container {
position: relative;
width: 100%;
max-width: 600px;
margin-left: auto;
margin-right: auto;
height: 300px;
max-height: 400px;
}

@media (min-width: 768px) {
.chart-container {
height: 350px;
}
}

/* Custom Scrollbar for inner panels */
.custom-scroll::-webkit-scrollbar {
width: 6px;
}

.custom-scroll::-webkit-scrollbar-track {
background: #f1f1f1;
}

.custom-scroll::-webkit-scrollbar-thumb {
background: #cbd5e1;
border-radius: 3px;
}

.custom-scroll::-webkit-scrollbar-thumb:hover {
background: #94a3b8;
}

.step-active {
border-color: #4f46e5;
background-color: #eef2ff;
color: #4f46e5;
font-weight: 600;
}

.tab-active {
border-bottom: 2px solid #4f46e5;
color: #4f46e5;
}

.fade-in {
animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(5px);
}

to {
opacity: 1;
transform: translateY(0);
}
}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-16">

    <section id="overview" class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        <div class="space-y-6">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-textMain leading-tight">
                Modular Threat Analysis <br>
                <span class="text-primary">Knowledge Graph</span>
            </h1>
            <p class="text-lg text-textMuted leading-relaxed">
                A comprehensive Python 3.11+ system designed to ingest raw <code
                    class="bg-stone-200 px-1 py-0.5 rounded text-sm">.eml</code> files, validate their authenticity
                via cryptography, and transform unstructured data into a relational knowledge graph of actors and
                forensic artifacts.
            </p>
            <div class="grid grid-cols-2 gap-4">
                <div
                    class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-primary font-bold text-lg mb-1">SQLModel</div>
                    <div class="text-sm text-textMuted">ORM & Validation</div>
                </div>
                <div
                    class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-secondary font-bold text-lg mb-1">AI Enriched</div>
                    <div class="text-sm text-textMuted">Gemini / OpenAI Analysis</div>
                </div>
                <div
                    class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-rose-500 font-bold text-lg mb-1">Crypto Checks</div>
                    <div class="text-sm text-textMuted">DKIM, SPF, ARC</div>
                </div>
                <div
                    class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-amber-500 font-bold text-lg mb-1">Atomization</div>
                    <div class="text-sm text-textMuted">Entity Extraction</div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full -mr-16 -mt-16"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-secondary/5 rounded-full -ml-12 -mb-12"></div>
            <h3 class="text-lg font-semibold text-textMain mb-4">System Capabilities</h3>
            <ul class="space-y-4">
                <li class="flex items-start">
                    <span
                        class="flex-shrink-0 h-6 w-6 flex items-center justify-center rounded-full bg-green-100 text-green-600 text-sm font-bold mt-0.5">&check;</span>
                    <div class="ml-4">
                        <p class="font-medium text-textMain">Forensic Ingestion</p>
                        <p class="text-sm text-textMuted mt-1">Parses headers, hops, and attachments efficiently.
                        </p>
                    </div>
                </li>
                <li class="flex items-start">
                    <span
                        class="flex-shrink-0 h-6 w-6 flex items-center justify-center rounded-full bg-green-100 text-green-600 text-sm font-bold mt-0.5">&check;</span>
                    <div class="ml-4">
                        <p class="font-medium text-textMain">Attribution & Identity</p>
                        <p class="text-sm text-textMuted mt-1">Maps emails to specific "Actors" using sender
                            patterns.</p>
                    </div>
                </li>
                <li class="flex items-start">
                    <span
                        class="flex-shrink-0 h-6 w-6 flex items-center justify-center rounded-full bg-green-100 text-green-600 text-sm font-bold mt-0.5">&check;</span>
                    <div class="ml-4">
                        <p class="font-medium text-textMain">Interactive Reporting</p>
                        <p class="text-sm text-textMuted mt-1">HTML reports with dashboards, timelines, and network
                            graphs.</p>
                    </div>
                </li>
            </ul>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <button onclick="runEngagementScan()" id="scan-btn"
                    class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    <span class="mr-2">‚ö°</span> Run Engagement Scan
                </button>
                <p id="scan-status" class="mt-2 text-xs text-center text-textMuted hidden"></p>
            </div>
        </div>
    </section>

    <hr class="border-gray-200">

    <section id="pipeline" class="scroll-mt-24">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-textMain">Processing Pipeline</h2>
            <p class="text-textMuted mt-2 max-w-3xl">
                The core `pipeline.py` orchestrates a linear flow, passing a `GmailMessage` object through five
                specialized processors. Click on a stage below to explore its logic.
            </p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="grid grid-cols-2 md:grid-cols-5 border-b border-gray-200">
                <button onclick="setPipelineStep(0)" id="step-btn-0"
                    class="step-btn p-4 text-center border-r border-gray-100 hover:bg-gray-50 transition-colors focus:outline-none step-active">
                    <div class="text-xs uppercase tracking-wide font-bold mb-1">Stage 1</div>
                    <div class="text-sm">Ingestion</div>
                </button>
                <button onclick="setPipelineStep(1)" id="step-btn-1"
                    class="step-btn p-4 text-center border-r border-gray-100 hover:bg-gray-50 transition-colors focus:outline-none text-textMuted">
                    <div class="text-xs uppercase tracking-wide font-bold mb-1">Stage 2</div>
                    <div class="text-sm">Verification</div>
                </button>
                <button onclick="setPipelineStep(2)" id="step-btn-2"
                    class="step-btn p-4 text-center border-r border-gray-100 hover:bg-gray-50 transition-colors focus:outline-none text-textMuted">
                    <div class="text-xs uppercase tracking-wide font-bold mb-1">Stage 3</div>
                    <div class="text-sm">Atomization</div>
                </button>
                <button onclick="setPipelineStep(3)" id="step-btn-3"
                    class="step-btn p-4 text-center border-r border-gray-100 hover:bg-gray-50 transition-colors focus:outline-none text-textMuted">
                    <div class="text-xs uppercase tracking-wide font-bold mb-1">Stage 4</div>
                    <div class="text-sm">Attribution</div>
                </button>
                <button onclick="setPipelineStep(4)" id="step-btn-4"
                    class="step-btn p-4 text-center hover:bg-gray-50 transition-colors focus:outline-none text-textMuted">
                    <div class="text-xs uppercase tracking-wide font-bold mb-1">Stage 5</div>
                    <div class="text-sm">AI Labeling</div>
                </button>
            </div>

            <div class="p-8 min-h-[300px] bg-stone-50/50">
                <div id="pipeline-content" class="fade-in grid grid-cols-1 md:grid-cols-3 gap-8">
                </div>
            </div>
        </div>
    </section>

    <section id="data-schema" class="scroll-mt-24">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-textMain">Data Schema & Storage</h2>
            <p class="text-textMuted mt-2 max-w-3xl">
                The system normalizes unstructured email data into a rigorous relational model using SQLModel. The
                database defaults to SQLite (`./forensics.db`) but is PostgreSQL-ready.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 h-auto md:h-[500px]">
            <div
                class="md:col-span-4 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden h-full">
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <h3 class="font-semibold text-textMain">Database Tables</h3>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <button onclick="showSchema('gmailmessage')"
                        class="schema-btn w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-50 hover:text-primary transition-colors focus:outline-none font-medium text-textMain bg-indigo-50 text-primary border border-indigo-100"
                        data-table="gmailmessage">
                        GmailMessage
                        <span class="block text-xs font-normal text-textMuted mt-0.5">Central fact table</span>
                    </button>
                    <button onclick="showSchema('actor')"
                        class="schema-btn w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-50 hover:text-primary transition-colors focus:outline-none font-medium text-textMain border border-transparent"
                        data-table="actor">
                        Actor
                        <span class="block text-xs font-normal text-textMuted mt-0.5">Identity
                            (Person/System)</span>
                    </button>
                    <button onclick="showSchema('observable')"
                        class="schema-btn w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-50 hover:text-primary transition-colors focus:outline-none font-medium text-textMain border border-transparent"
                        data-table="observable">
                        Observable
                        <span class="block text-xs font-normal text-textMuted mt-0.5">Technical Artifacts (IP,
                            URL)</span>
                    </button>
                    <button onclick="showSchema('ailabel')"
                        class="schema-btn w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-50 hover:text-primary transition-colors focus:outline-none font-medium text-textMain border border-transparent"
                        data-table="ailabel">
                        AILabel
                        <span class="block text-xs font-normal text-textMuted mt-0.5">LLM Analysis Results</span>
                    </button>
                    <button onclick="showSchema('attachment')"
                        class="schema-btn w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-50 hover:text-primary transition-colors focus:outline-none font-medium text-textMain border border-transparent"
                        data-table="attachment">
                        Attachment
                        <span class="block text-xs font-normal text-textMuted mt-0.5">File Metadata & Hashes</span>
                    </button>
                </div>
            </div>

            <div
                class="md:col-span-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col h-full relative">
                <div id="schema-viewer" class="fade-in flex-1">
                </div>
                <div class="absolute bottom-4 right-6 text-xs text-gray-300 font-mono">schema: gmail_models.py</div>
            </div>
        </div>
    </section>

    <section id="dashboard" class="scroll-mt-24 pb-20">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-textMain">Interactive Report Output</h2>
            <p class="text-textMuted mt-2 max-w-3xl">
                The system generates a self-contained HTML report (`report.html`) featuring dashboards, timelines,
                and network graphs. Below is a simulation of the data visualization capabilities.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-semibold text-textMain mb-4">Email Verification Status</h3>
                <div class="chart-container">
                    <canvas id="verificationChart"></canvas>
                </div>
                <p class="text-xs text-center text-textMuted mt-4">Based on DKIM, SPF, and ARC checks.</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-semibold text-textMain mb-4">Extracted Observables by Type</h3>
                <div class="chart-container">
                    <canvas id="observablesChart"></canvas>
                </div>
                <p class="text-xs text-center text-textMuted mt-4">Entities extracted via regex in 'Atomization'
                    stage.</p>
            </div>
        </div>

        <div class="mt-8 bg-slate-900 rounded-xl p-6 shadow-lg text-slate-300 font-mono text-sm overflow-x-auto">
            <div class="flex items-center justify-between mb-4 border-b border-slate-700 pb-2">
                <span class="font-bold text-white">JSON API Output Preview</span>
                <span class="text-xs bg-slate-700 px-2 py-1 rounded">GET /api/messages</span>
            </div>
            <pre class="text-xs leading-relaxed">
{
"status": "success",
"data": [
{
  "id": "msg_12938",
  "subject": "Urgent Invoice Payment",
  "verification": "SUSPICIOUS",
  "ai_label": {
    "intent": "Phishing",
    "sentiment": "Urgent/Threatening",
    "summary": "Sender demands immediate payment for unknown services."
  },
  "observables": [
    {"type": "IP", "value": "192.168.1.55", "malicious": true},
    {"type": "DOMAIN", "value": "pay-secure-now.com", "malicious": true}
  ]
}
]
}</pre>
        </div>
    </section>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // --- DATA: Pipeline Steps ---
    const pipelineData = [
        {
            title: "Ingestion",
            file: "ingestion.py",
            desc: "Parses raw .eml files and normalizes content structure.",
            col1: `<h4 class="font-bold text-gray-900 mb-2">Input</h4>
                   <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                       <li>Raw <code class="bg-gray-100 px-1">.eml</code> files</li>
                       <li>Source: <code>forensics/evidence/</code></li>
                   </ul>`,
            col2: `<h4 class="font-bold text-gray-900 mb-2">Process</h4>
                   <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                       <li>MIME Structure Parsing</li>
                       <li>Header Extraction (Date, To, From)</li>
                       <li>Body Normalization (HTML -> Text)</li>
                       <li>Attachment Hashing (MD5/SHA256)</li>
                   </ul>`,
            col3: `<h4 class="font-bold text-gray-900 mb-2">Output</h4>
                   <p class="text-sm text-gray-600">Structured <code>GmailMessage</code> object with normalized body and metadata.</p>`
        },
        {
            title: "Verification",
            file: "verification.py",
            desc: "Cryptographically validates the email to detect spoofing.",
            col1: `<h4 class="font-bold text-gray-900 mb-2">Goal</h4>
                   <p class="text-sm text-gray-600">Determine if the email was spoofed or altered in transit.</p>`,
            col2: `<h4 class="font-bold text-gray-900 mb-2">Checks</h4>
                   <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                       <li><strong>DKIM:</strong> Verifies signature against public key.</li>
                       <li><strong>SPF:</strong> Checks authorized sending IPs.</li>
                       <li><strong>ARC:</strong> Validates chain of trust for forwarded mail.</li>
                   </ul>`,
            col3: `<h4 class="font-bold text-gray-900 mb-2">Result Status</h4>
                   <div class="flex gap-2 mt-1">
                       <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">VERIFIED</span>
                       <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded">SUSPICIOUS</span>
                       <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded">FAILED</span>
                   </div>`
        },
        {
            title: "Atomization",
            file: "atomizer.py",
            desc: "Extracts actionable intelligence (Observables) using Regex.",
            col1: `<h4 class="font-bold text-gray-900 mb-2">Technique</h4>
                   <p class="text-sm text-gray-600">Regex patterns and heuristics scan headers and body text.</p>`,
            col2: `<h4 class="font-bold text-gray-900 mb-2">Extracted Artifacts</h4>
                   <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                       <li>IPv4 / IPv6 Addresses</li>
                       <li>Domains & URLs (C2 links)</li>
                       <li>Email Addresses (targets)</li>
                       <li>Crypto Wallets (BTC/ETH)</li>
                   </ul>`,
            col3: `<h4 class="font-bold text-gray-900 mb-2">Output</h4>
                   <p class="text-sm text-gray-600">List of <code>Observable</code> objects linked to the message via a many-to-many relationship.</p>`
        },
        {
            title: "Attribution",
            file: "attribution.py",
            desc: "Resolves identity and groups messages by Actor.",
            col1: `<h4 class="font-bold text-gray-900 mb-2">Goal</h4>
                   <p class="text-sm text-gray-600">Identity Resolution & Actor Mapping.</p>`,
            col2: `<h4 class="font-bold text-gray-900 mb-2">Process</h4>
                   <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                       <li>Matches <code>From</code> address to known DB entities.</li>
                       <li>Performs RDAP/Whois lookups on domains.</li>
                       <li>Calculates initial Trust Score.</li>
                   </ul>`,
            col3: `<h4 class="font-bold text-gray-900 mb-2">Output</h4>
                   <p class="text-sm text-gray-600"><code>Actor</code> entity created or updated and linked to the message.</p>`
        },
        {
            title: "AI Labeling",
            file: "ai_labeler.py",
            desc: "Uses LLMs (Gemini/OpenAI) for cognitive analysis.",
            col1: `<h4 class="font-bold text-gray-900 mb-2">Input</h4>
                   <p class="text-sm text-gray-600">Sanitized email body text + Subject line.</p>`,
            col2: `<h4 class="font-bold text-gray-900 mb-2">Prompt Engineering</h4>
                   <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                       <li>Summarize in one sentence.</li>
                       <li>Classify Intent (Phishing, Extortion, etc).</li>
                       <li>Assess Urgency & Sentiment.</li>
                   </ul>`,
            col3: `<h4 class="font-bold text-gray-900 mb-2">Output</h4>
                   <p class="text-sm text-gray-600"><code>AILabel</code> object containing structured cognitive metadata.</p>`
        }
    ];

    // --- DATA: Schema ---
    const schemaData = {
        'gmailmessage': {
            name: "GmailMessage",
            columns: [
                { name: "id", type: "Integer", desc: "Primary Key" },
                { name: "gmail_id", type: "String", desc: "Unique Message-ID from header" },
                { name: "thread_id", type: "String", desc: "Grouping identifier" },
                { name: "subject", type: "String", desc: "Email Subject" },
                { name: "sender", type: "String", desc: "From address" },
                { name: "recipient", type: "String", desc: "To address" },
                { name: "body_text", type: "Text", desc: "Normalized content" },
                { name: "is_verified", type: "Boolean", desc: "Result of crypto checks" }
            ],
            relationships: ["Actor", "Observable", "AILabel", "Attachment"]
        },
        'actor': {
            name: "Actor",
            columns: [
                { name: "id", type: "Integer", desc: "Primary Key" },
                { name: "name", type: "String", desc: "Display Name" },
                { name: "email", type: "String", desc: "Unique Email Address" },
                { name: "trust_score", type: "Float", desc: "0.0 to 1.0 Reputation" }
            ],
            relationships: ["GmailMessage (One-to-Many)"]
        },
        'observable': {
            name: "Observable",
            columns: [
                { name: "id", type: "Integer", desc: "Primary Key" },
                { name: "type", type: "Enum", desc: "IP, URL, DOMAIN, CRYPTO, EMAIL" },
                { name: "value", type: "String", desc: "The extracted artifact" },
                { name: "malicious_score", type: "Float", desc: "Threat Intelligence Score" }
            ],
            relationships: ["MessageObservableLink (Many-to-Many)"]
        },
        'ailabel': {
            name: "AILabel",
            columns: [
                { name: "id", type: "Integer", desc: "Primary Key" },
                { name: "message_id", type: "FK", desc: "Link to GmailMessage" },
                { name: "summary", type: "Text", desc: "One sentence summary" },
                { name: "intent", type: "String", desc: "Phishing, Spam, Legit, etc." },
                { name: "urgency", type: "Integer", desc: "1-10 Scale" },
                { name: "sentiment", type: "String", desc: "Tone analysis" }
            ],
            relationships: ["GmailMessage (One-to-One)"]
        },
        'attachment': {
            name: "Attachment",
            columns: [
                { name: "id", type: "Integer", desc: "Primary Key" },
                { name: "filename", type: "String", desc: "Original file name" },
                { name: "mime_type", type: "String", desc: "e.g., application/pdf" },
                { name: "size", type: "Integer", desc: "Bytes" },
                { name: "md5_hash", type: "String", desc: "For IOC matching" },
                { name: "sha256_hash", type: "String", desc: "For IOC matching" }
            ],
            relationships: ["GmailMessage"]
        }
    };

    // --- Logic: Pipeline Stepper ---
    function setPipelineStep(index) {
        // Update Buttons
        document.querySelectorAll('.step-btn').forEach((btn, idx) => {
            if (idx === index) {
                btn.classList.add('step-active', 'bg-indigo-50', 'text-primary', 'border-indigo-100');
                btn.classList.remove('text-textMuted', 'border-transparent');
            } else {
                btn.classList.remove('step-active', 'bg-indigo-50', 'text-primary', 'border-indigo-100');
                btn.classList.add('text-textMuted');
            }
        });

        // Update Content
        const data = pipelineData[index];
        const container = document.getElementById('pipeline-content');

        // Re-render with fade animation
        container.classList.remove('fade-in');
        void container.offsetWidth; // trigger reflow
        container.classList.add('fade-in');

        container.innerHTML = `
            <div class="md:col-span-1">
                <h3 class="text-xl font-bold text-textMain">${data.title}</h3>
                <code class="text-xs text-primary bg-indigo-50 px-2 py-1 rounded mt-2 inline-block">${data.file}</code>
                <p class="text-gray-600 mt-4 leading-relaxed">${data.desc}</p>
            </div>
            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                    ${data.col1}
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-100 shadow-sm border-t-4 border-t-primary">
                    ${data.col2}
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                    ${data.col3}
                </div>
            </div>
        `;
    }

    // --- Logic: Schema Viewer ---
    function showSchema(tableKey) {
        const data = schemaData[tableKey];
        const viewer = document.getElementById('schema-viewer');

        // Button Styles
        document.querySelectorAll('.schema-btn').forEach(btn => {
            if (btn.dataset.table === tableKey) {
                btn.classList.add('bg-indigo-50', 'text-primary', 'border-indigo-100');
                btn.classList.remove('border-transparent');
            } else {
                btn.classList.remove('bg-indigo-50', 'text-primary', 'border-indigo-100');
                btn.classList.add('border-transparent');
            }
        });

        // Render Table Details
        let rowsHtml = data.columns.map(col => `
            <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                <td class="py-3 px-2 font-mono text-sm text-primary font-medium">${col.name}</td>
                <td class="py-3 px-2 text-sm text-gray-500">${col.type}</td>
                <td class="py-3 px-2 text-sm text-gray-600 italic">${col.desc}</td>
            </tr>
        `).join('');

        let relsHtml = data.relationships.map(rel => `
            <span class="inline-block bg-teal-50 text-teal-700 text-xs px-2 py-1 rounded border border-teal-100 mr-2 mb-2">
                üîó ${rel}
            </span>
        `).join('');

        viewer.innerHTML = `
            <div class="animate-fadeIn">
                <div class="flex items-baseline justify-between mb-6">
                    <h3 class="text-2xl font-bold text-textMain flex items-center">
                        <span class="text-2xl mr-2">üóÉÔ∏è</span> ${data.name}
                    </h3>
                    <span class="text-sm text-textMuted uppercase tracking-wider font-semibold">Table Definition</span>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Relationships</h4>
                    <div class="flex flex-wrap">
                        ${relsHtml}
                    </div>
                </div>

                <div class="overflow-hidden rounded-lg border border-gray-200">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-2 text-xs font-bold text-gray-500 uppercase">Column</th>
                                <th class="py-2 px-2 text-xs font-bold text-gray-500 uppercase">Type</th>
                                <th class="py-2 px-2 text-xs font-bold text-gray-500 uppercase">Description</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            ${rowsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // --- Logic: Scrolling ---
    function scrollToSection(id) {
        document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Init Pipeline
        setPipelineStep(0);

        // Init Schema
        showSchema('gmailmessage');

        // Init Charts (Chart.js)
        initCharts();
    });

    function initCharts() {
        // Chart 1: Verification Status (Doughnut)
        const ctx1 = document.getElementById('verificationChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Verified', 'Suspicious', 'Failed'],
                datasets: [{
                    data: [65, 25, 10],
                    backgroundColor: ['#0d9488', '#eab308', '#f43f5e'], // Teal, Yellow, Rose
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Chart 2: Observables (Bar)
        const ctx2 = document.getElementById('observablesChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['IP Addresses', 'Domains', 'URLs', 'Crypto Addr', 'Email Addr'],
                datasets: [{
                    label: 'Count',
                    data: [120, 85, 210, 15, 60],
                    backgroundColor: '#4f46e5',
                    borderRadius: 4
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                },
                scales: {
                    y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function runEngagementScan() {
        const btn = document.getElementById('scan-btn');
        const status = document.getElementById('scan-status');

        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin mr-2">‚ü≥</span> Starting Scan...';
        status.textContent = '';
        status.classList.add('hidden');

        fetch('./pipeline/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'accepted') {
                    status.textContent = `Success: ${data.message}`;
                    status.className = "mt-2 text-xs text-center text-green-600 font-medium fade-in";
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(err => {
                console.error(err);
                status.textContent = `Error: ${err.message}`;
                status.className = "mt-2 text-xs text-center text-red-600 font-medium fade-in";
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<span class="mr-2">‚ö°</span> Run Engagement Scan';
            });
    }
</script>
{% endblock %}